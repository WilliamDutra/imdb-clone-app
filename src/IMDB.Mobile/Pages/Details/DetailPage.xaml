<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="IMDB.Mobile.Pages.Details.DetailPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:cards="clr-namespace:IMDB.Mobile.Components.Cards"
    xmlns:ffimageloading="clr-namespace:FFImageLoading.Maui;assembly=FFImageLoading.Maui"
    xmlns:language="clr-namespace:IMDB.Mobile.Resources"
    xmlns:model="clr-namespace:IMDB.ApiClient;assembly=IMDB.ApiClient"
    xmlns:skeleton="clr-namespace:IMDB.Mobile.Components.Skeletons"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:IMDB.Mobile.Pages.Details"
    x:Name="detailPage"
    x:DataType="vm:DetailPageViewModel"
    Shell.NavBarIsVisible="True">

    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            BindingContext="{Binding Source={x:Reference detailPage}, Path=BindingContext}"
            Command="{Binding InitializeCommand}"
            EventName="Loaded" />
    </ContentPage.Behaviors>

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False" />
    </Shell.BackButtonBehavior>

    <Shell.TitleView>
        <HorizontalStackLayout Spacing="10">

            <HorizontalStackLayout.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding BackToHomePageCommand}" />
            </HorizontalStackLayout.GestureRecognizers>

            <Image
                Aspect="AspectFill"
                Source="back_button_icon.png"
                VerticalOptions="Center" />

            <Label VerticalTextAlignment="Center">
                <Label.FormattedText>
                    <FormattedString>
                        <Span
                            FontFamily="PoppinsRegular"
                            FontSize="20"
                            Text="{x:Static language:Resource.text_back_button_details}"
                            TextColor="White" />
                        <Span
                            FontFamily="PoppinsRegular"
                            FontSize="20"
                            TextColor="{StaticResource ColorSecondary}">
                            .
                        </Span>
                    </FormattedString>
                </Label.FormattedText>
            </Label>
        </HorizontalStackLayout>
    </Shell.TitleView>

    <ScrollView>

        <VerticalStackLayout>

            <Grid RowSpacing="10">
                <Grid.RowDefinitions>
                    <RowDefinition />
                    <RowDefinition />
                    <RowDefinition />
                    <RowDefinition />
                </Grid.RowDefinitions>

                <ffimageloading:CachedImage
                    Aspect="AspectFill"
                    CacheDuration="30"
                    DownsampleToViewSize="True"
                    ErrorPlaceholder="film_icon.png"
                    HeightRequest="400"
                    Source="{Binding Thumbnail}" />

                <BoxView HeightRequest="100" VerticalOptions="End">
                    <BoxView.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                            <GradientStop Offset="0.0" Color="#00FFFFFF" />
                            <GradientStop Offset="2.0" Color="{StaticResource ColorPrimary}" />
                        </LinearGradientBrush>
                    </BoxView.Background>
                </BoxView>


                <VerticalStackLayout
                    Grid.Row="0"
                    Padding="10"
                    HorizontalOptions="Start"
                    VerticalOptions="End">

                    <Label
                        FontFamily="PoppinsBlack"
                        FontSize="26"
                        LineBreakMode="WordWrap"
                        Text="{Binding Title}"
                        WidthRequest="300" />

                    <HorizontalStackLayout Spacing="10">
                        <Label
                            FontFamily="PoppinsBold"
                            FontSize="18"
                            HorizontalTextAlignment="Center"
                            Text="{Binding Rating}"
                            VerticalTextAlignment="Center" />

                        <toolkit:RatingView
                            CustomShapePath="M15.5626 19.2229C15.4005 19.2228 15.2408 19.1834 15.0973 19.1081L10.0001 16.4284L4.90296 19.1081C4.73778 19.1949 4.55161 19.2338 4.3655 19.2203C4.17938 19.2069 4.00074 19.1416 3.84977 19.032C3.6988 18.9223 3.58152 18.7726 3.51119 18.5997C3.44086 18.4269 3.42028 18.2378 3.45178 18.0539L4.42542 12.3781L0.301885 8.35913C0.168302 8.22885 0.0738231 8.0638 0.0291246 7.88263C-0.0155739 7.70147 -0.00870976 7.51141 0.0489412 7.33394C0.106592 7.15648 0.212732 6.99867 0.355365 6.87836C0.497998 6.75805 0.671438 6.68004 0.856085 6.65313L6.55482 5.825L9.10312 0.661341C9.19523 0.505393 9.3264 0.376153 9.4837 0.286372C9.64099 0.196591 9.81898 0.149371 10.0001 0.149371C10.1812 0.149371 10.3592 0.196591 10.5165 0.286372C10.6738 0.376153 10.805 0.505393 10.8971 0.661341L13.4454 5.82491L19.1441 6.65304C19.3288 6.67995 19.5022 6.75796 19.6449 6.87827C19.7875 6.99858 19.8936 7.15639 19.9513 7.33385C20.0089 7.51132 20.0158 7.70138 19.9711 7.88254C19.9264 8.06371 19.8319 8.22876 19.6983 8.35904L15.5748 12.378L16.5484 18.0538C16.573 18.1974 16.566 18.3446 16.5278 18.4851C16.4896 18.6257 16.4212 18.7562 16.3273 18.8675C16.2334 18.9788 16.1163 19.0683 15.9842 19.1297C15.8521 19.1911 15.7083 19.2229 15.5626 19.2229Z"
                            EmptyShapeColor="LightGray"
                            FillColor="{StaticResource ColorSecondary}"
                            HorizontalOptions="Center"
                            IsReadOnly="True"
                            MaximumRating="10"
                            Rating="{Binding Rating}"
                            ShapeBorderColor="Transparent"
                            ShapeBorderThickness="0" />
                    </HorizontalStackLayout>

                </VerticalStackLayout>

                <Label Grid.Row="1" Text="{Binding Overview}" />

                <VerticalStackLayout Grid.Row="2" Padding="10">
                    <Label>
                        <Label.FormattedText>
                            <FormattedString>
                                <Span
                                    FontFamily="PoppinsBold"
                                    FontSize="20"
                                    Text="{Static language:Resource.title_detail_cast}"
                                    TextColor="White" />
                                <Span
                                    FontFamily="PoppinsBold"
                                    FontSize="20"
                                    TextColor="{StaticResource ColorSecondary}">
                                    .
                                </Span>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <CollectionView
                        Margin="0,20"
                        ItemsSource="{Binding Actors}"
                        SelectionMode="Single">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout ItemSpacing="10" Orientation="Horizontal" />
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="model:Actor">
                                <Grid>
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DetailPageViewModel}}, Path=ActorDetailsCommand}" CommandParameter="{Binding Id}" />
                                    </Grid.GestureRecognizers>
                                    <cards:CardViewActorComponent
                                        Name="{Binding Name}"
                                        Grid.Row="1"
                                        CardHeight="120"
                                        CardWidth="120"
                                        Photo="{Binding Photo}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>


                </VerticalStackLayout>

                <Button
                    Grid.Row="3"
                    BackgroundColor="{StaticResource ColorSecondary}"
                    Command="{Binding AddToMyListCommand}"
                    ImageSource="bookmark_icon.png"
                    Text="{Static language:Resource.text_button_add_list_details}"
                    TextColor="White" />

                <Grid.Triggers>
                    <DataTrigger
                        Binding="{Binding IsBusy}"
                        TargetType="Grid"
                        Value="True">
                        <Setter Property="IsVisible" Value="False" />
                    </DataTrigger>
                </Grid.Triggers>

            </Grid>

            <Grid RowSpacing="10">
                <Grid.RowDefinitions>
                    <RowDefinition />
                    <RowDefinition />
                    <RowDefinition />
                </Grid.RowDefinitions>
                <skeleton:SkeletonView
                    Grid.Row="0"
                    BackgroundColor="{StaticResource Gray100}"
                    HeightRequest="350" />
                <skeleton:SkeletonView
                    Grid.Row="1"
                    BackgroundColor="{StaticResource Gray100}"
                    HeightRequest="60" />
                <skeleton:SkeletonView
                    Grid.Row="2"
                    BackgroundColor="{StaticResource Gray100}"
                    HeightRequest="150" />

                <Grid.Triggers>
                    <DataTrigger
                        Binding="{Binding IsBusy}"
                        TargetType="Grid"
                        Value="False">
                        <Setter Property="IsVisible" Value="False" />
                    </DataTrigger>
                </Grid.Triggers>

            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>